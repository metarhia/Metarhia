# Metarhia common abstractions

- Metaschema

Metaschema — это схема для описания структур, сигнатур функций и методов, контрактов, других схем, валидации и генерации тайпингов.

- Schema

Schema это схема для моделей. Она используется для описания моделей и валидации.

- Model

Model это абстракция для работы с данными. Она используется для описания моделей и валидации.

- Type

Type это абстракция для работы с данными. Она используется для валидации.

- Application

Application это абстракция прикладного приложения. Состоит из конфигурационных файлов, моделей, ари, прикладного кода, планировщика, каналов, кеша и др.

- Cache

Cache это абстракция для работы с кэшем. Она используется для кэширования данных.

- Planner

Planner это абстракция для работы с планировщиком. Она используется для планирования задач.

- Procedure

Procedure это абстракция для работы с удалёнными процедурами описываемыми в формате Metascript. 

- Scheduler

Scheduler это абстракция для работы с планировщиком. Она используется для планирования задач.

- Server

Server это абстракция для работы с сервером. Она используется для описания сервера, становлением связей с клиентами и вызовом сервисов в экосистеме Метархии.

- Channel

Вебсокет или канал связи между Metacom клиентом и сервером.

- Metacom

Протокол обмена сообщениями между клиентом и сервером. В начале соединения присылает список доступных процедур и событий. После этого клиент может вызывать процедуры и слушать события.

- MetaScript

Определённая форма описания процедур и событий на сервере для Metacom.

- Database

В настоящее время поддерживается только PostgreSQL, а Redis и другие бд могут быть подгоужены как зависимости.

- Query

Query это абстракция для работы с запросами. Она используется для описания запросов и валидации.

- Config

Config это абстракция для работы с конфигурационными файлами. Она используется для описания конфигурационных файлов и валидации.

- Logger

Logger это абстракция для работы с логами. Она используется для логирования в разных форматах.

- Sheet

Sheet это абстракция для работы с таблицами. Она используется для описания таблиц и валидации.

- DirectoryWatcher

DirectoryWatcher это механизм для работы с файловой системой. Она используется для отслеживания изменений в файлах с прикладным кодом и обновляет на лету список доступных с клиента процедур.

# Metarhia NPM packages

## Impress

Центральный пакет для создания приложений на базе Metarhia. Предоставляет базовые классы для создания приложений, а также набор инструментов для упрощения разработки. 
Валидирует конфигурацию, запускает логгер и Planner для тасков.
Запускает воркеры (worker_threads) типов: "balancer" (если есть), "server" на каждый порт и "worker" в соответствии с размерами config.workers.pool, 
слушает события от них и вызывает соответствующие процедуры, вызывая свободный worker_thread из пулла.
Если существует файл .applications в директории процесса, берёт оттуда список приложений и запускает их, если нет - берёт аппликацию из корневого процесса.
Сохраняет аппликацию в Map impress.applications

Impress содержит в себе следующие модули:

### Application
(/impress/lib/application.js)
extends EventEmitter 

Класс управляющий прикладным кодом, используя остальные нижеперечисленные компоненты. Вызываеться из воркера.
Прикладной код берётся из следующих директорий в папке application:

  - this.schemas = new Schemas('schemas', this); - схемы и модели для организации и валидации данных
  - this.static = new Resources('static', this); - статические файлы для загрузки фронтенда
  - this.resources = new Resources('resources', this); - статические файлы .md для вызовов из фронтенда
  - this.api = new Interfaces('api', this); - исполняемые файлы с методами для вызовов из фронтенда
  - this.lib = new Modules('lib', this);  - исполняемые файлы с методами для вызовов из фронтенда
  - this.db = new Modules('db', this); - библиотеки связи с базами данных
  - this.bus = new Services('bus', this); - занимается вызовами к внешним ресурсам
  - this.domain = new Modules('domain', this); - занимается вызовами к внешним ресурсам по запросам с фронтенда используя bus
  - this.scheduler = new Scheduler(this);

Создаёт песочницу с ограниченным доступом к ресурсам node.js, в которой исполняется прикладной код. Начинает отслеживать изменения этого кода в реальном времени.

### Auth
(/impress/lib/auth.js)
Коллекция функций для работы с сессиями и юзерами

### Cache
(/impress/lib/cache.js)
Работает с вотчером аппликации, следит за ихменениями файлов. Служит прототипом для некоторых классов.

### Dependencies
(/impress/lib/dependencies.js)
Загружает все нужные для аппликации зависимости, в точ числе из project.json, и сохраняет их как свойства глобальных объектов: node, npm и metarhia, доступные из прикладного кода

### Files
(/impress/lib/files.js)
Занимается загрузкой статических файлов на сервер

### Interfaces
(/impress/lib/interfaces.js)
Занимается прикладным кодом аппликации. Запускает код по вызовам с фронтэнда по пути к файлу с методом.

### Modules
(/impress/lib/modules.js)
extends Cache
Занимается прикладным кодом аппликации. Запускает код по вызовам с бэкэнда.

### Planner
(/impress/lib/planner.js)

Planner это планировщик исполняющий код один или много раз, похожий на cron но в более удобном формате описания и в большом количестве сценариев. 
Применяет механизм Semaphore, позволяющий контролируемое, в соответствии с конфигурацией, распараллеливание по worker_threads исполнения заданий.
Удаляет файлы описаний после завершения срока действия задания.

Конфигурируется секцией scheduler в application/conf/server.js

Пример:

```
scheduler: {
    concurrency: 10,
    size: 2000,
    timeout: 3000,
  }
```

Описания задач кранятся в папке /application/tasks в формате yyyy-mm-dd-id-{{int}}.json. 

Пример (2022-09-22-id-0.json):
```
{
    "name":"name",
    "every":"Sep 10th 10s",
    "args":{"i":2},
    "run":"lib.task1.f1",
    "app":"/path/to/root",
    "id":"2022-09-22-id-0"
}
```
и запускает код в файле /application/lib/task1/f1.js каждые 10 секунд на протяжении 10-го сентября

### Enterprise bus
(/impress/lib/services.js)

Механизм для вызовов к внешним ресурсам (например API e-mail сервисов). Сейчас поддерживаются только простые GET и POST.

Вызовоы хранятся в /application/bus в отдельных папках. Каждая папка должна содержать файл .service.js с метаданными. 

Пример (/application/bus/worldTime/.service.js):
```
({
  url: 'http://worldtimeapi.org/api',
  limits: [
    { calls: 10, per: '1m' },
    { calls: 10000, per: '1d' },
  ],
});

```
и произвольное количество js файлов с внешними rpc методами. 

Пример (/application/bus/worldTime/listTimezones.js):
```
({
  parameters: {
    area: 'string',
  },

  method: {
    get: 'timezone',
    path: ['area'],
  },

  returns: { array: 'string' },
});
```

### Procedure
(/impress/lib/procedure.js)

Занимается выполнением прикладного кода, под контролем Семафора. В качестве одного из аргументов (script, methodName, application) получает скрипт из файла с имененм метода
Может обрабатывать как объекты так и функции. 

### Resources
(/impress/lib/resources.js)
extends Cache

Сохраняет в Map и обновляет прикладной код из файлов

### Sheduler
(/impress/lib/scheduler.js)

Связывается с worker threads и контролирует исполнение на них тасков

### Schemas
(/impress/lib/schemas.js)
extends Cache

Читает, сохранят в кэше модели и схемы из файлов и следит за изменениями файлов

### Services
(/impress/lib/services.js)
extends Modules

Обращается к внешним сервисам по внешнему запросу, валидирует аргументы и результаты

### Worker
(/impress/lib/worker.js)

Основной рабочий компонент импресса запускаемый на worker_threads. 
Читает конфигурацию, запускает Metacom сервер, занимается логами, инициализирует аппликацию для исполнения прикладного кода.

## Metacom

Протокол для обмена данными между приложениями на базе Impress. Предоставляет возможность вызывать удаленные методы, а также реализует механизмы авторизации и аутентификации.
Состоит из следующих компонентов:
### Channel
#### class Session
Сохраняет сессию в application.auth 
#### class Client
#### class Channel

###  Client 
#### class Metacom extends EventEmitter
### Http

### Server
### Static
### Streams
### Transport
### Ws

## Metavm

Виртуальная машина для выполнения кода на MetaScript. Аналог exec() в Node.js, с возможностью ограничивать доступ исполняемого кода к системным ресурсам. Позволяет добавлять новые функции в язык MetaScript и обновлять работу системы не перезагружая процесс.

## Metaconfiguration

Библиотека для работы с конфигурационными файлами. Позволяет объединять конфигурационные файлы, а также переопределять их значения.

## Metalog

Библиотека для работы с логами. Предоставляет возможность логировать сообщения в различные источники (командная строка и файлы логов), а также управлять уровнями логирования.

## Metadomain

Библиотека для работы с доменами. Предоставляет возможность создавать домены, а также управлять их состоянием. Позволяет создавать домены с различными настройками, например, с разными логами, разными конфигурациями, разными базами данных.

## Metasql

Библиотека для работы с SQL. Позволяет создавать запросы к базам данных, используя схемы, описанные в формате Metaschema. Предоставляет возможность создавать запросы с помощью функций, а также с помощью SQL-строк. Позволяет создавать запросы с различными настройками, например, с разными логами, разными конфигурациями, разными базами данных.

## Metaschema

Библиотека для работы со схемами. Позволяет создавать схемы, валидировать данные, создавать модели, которые могут взаимодействовать с базами данных, используя схемы, описанные в формате Metaschema. Предоставляет возможность создавать схемы с различными настройками, например, с разными логами, разными конфигурациями, разными базами данных. 

## Metatests

Библиотека для тестирования. Позволяет создавать тесты, выполнять их в параллельном режиме, а также генерировать отчеты о прохождении тестов. 

## Metamail

Библиотека для отправки почты.

## Metacalc

Библиотека для реактивной работы с вычислениями, по аналогии электронными таблицами. 

## Metautil

Библиотека утилит используемых в многих других библиотеках. 

Состоит из:

### Async
Отменяемые асинхронные операции
### Crypto
Библиотека для генерации и валидации токенов и паролей

### Network
Библиотека для приема и отправки JSON сообщений в теле запроса
### Semaphore
Библиотека создающая и контролирующая очередь задач на Промисах исполняемых с заданным таймаутом для блокирования разделяемых ресурсов во время параллельного исполнения кода в разных потоках
```
constructor(concurrency, size = 0, timeout = 0)
```
### Pool
Библиотека создающая и контролирующая пулл уникальных задач, данных или воркеров на Промисах исполняемых по очереди с заданным таймаутом для распределения разделяемых ресурсов
```
constructor(options = {timeout: 0})
```

### Utilities
Коллекция вспомогательных функций для строк, чисел, времени, url и так далее.



## Metawatch

Занимается отслеживанием изменений в файловой структуре прикладного кода используя рекурсивно fs.watch и EventEmitter